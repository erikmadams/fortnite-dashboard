<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KSEL Team Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <div class="max-w-7xl mx-auto p-6">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg mb-6 p-6 border-l-4 border-red-500">
            <div class="flex items-center justify-between mb-0 min-h-[72px]">
                <div class="flex items-center">
                    <img src="https://raw.githubusercontent.com/erikmadams/ksel-fortnite-results/main/KSEL_Header_Black_48x198.png" alt="KSEL Logo" style="height: 48px; width: 198px;" class="rounded" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="flex items-center justify-center text-white font-bold rounded text-lg" style="background-color: #EE2A3E; height: 48px; width: 198px; display: none;">
                        KSEL
                    </div>
                </div>
                
                <div class="flex-1 text-center">
                    <h1 class="text-3xl font-bold text-gray-800">Team Analytics Dashboard</h1>
                    <p class="text-gray-600">Performance tracking and statistics</p>
                </div>
                
                <div class="flex gap-2">
                    <button onclick="loadData()" class="text-white px-6 rounded-lg inline-flex items-center justify-center text-center gap-2 font-medium transition-colors hover:opacity-90 h-11" style="background-color: #EE2A3E">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        Refresh Data
                    </button>
                </div>
            </div>
        </div>

        <!-- Season Standings -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <i data-lucide="trophy" class="w-5 h-5 text-yellow-600"></i>
                    Season Standings
                </h2>
                <div class="flex items-center gap-3">
                    <!-- Game Mode Filter for Standings -->
                    <div class="flex items-center gap-2">
                        <label class="text-sm font-medium text-gray-700">Mode:</label>
                        <select id="standingsGameModeFilter" onchange="updateStandingsForGameMode()" class="h-9 border border-gray-300 rounded-lg px-3 py-1 focus:ring-2 focus:ring-red-500 focus:border-red-500 text-sm">
                            <option value="Battle Royale">Battle Royale</option>
                            <option value="Zero Build">Zero Build</option>
                        </select>
                    </div>
                    
                    <button 
                        id="expandStandingsBtn"
                        onclick="toggleStandings()"
                        class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg inline-flex items-center justify-center gap-2 font-medium transition-colors text-sm"
                    >
                        <i data-lucide="expand" class="w-4 h-4" id="expandIcon"></i>
                        <span id="expandText">Show All Teams</span>
                    </button>
                </div>
            </div>
            
            <div id="standingsContainer">
                <div id="top30Standings" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="col-span-3 text-center text-gray-500 py-8">
                        Loading team standings...
                    </div>
                </div>
                
                <div id="allStandings" style="display: none;" class="space-y-2">
                    <!-- All teams will be populated here when expanded -->
                </div>
            </div>
            
            <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <div class="flex items-center gap-2 text-sm">
                    <i data-lucide="info" class="w-4 h-4 text-blue-600"></i>
                    <span class="font-medium text-blue-800">Finals Info:</span>
                    <span class="text-blue-700">Top 25 teams in each game mode clinch the Finals</span>
                </div>
            </div>
        </div>

        <!-- Leaderboards Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <i data-lucide="medal" class="w-5 h-5 text-yellow-500"></i>
                    Best Teams (Avg Placement)
                </h3>
                <div id="teamLeaderboard" class="space-y-2">
                    <div class="text-gray-500 text-center py-4">Loading...</div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <i data-lucide="target" class="w-5 h-5 text-blue-500"></i>
                    Highest Scoring Teams
                </h3>
                <div id="pointsLeaderboard" class="space-y-2">
                    <div class="text-gray-500 text-center py-4">Loading...</div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <i data-lucide="crosshair" class="w-5 h-5 text-red-500"></i>
                    Most Eliminations
                </h3>
                <div id="elimsLeaderboard" class="space-y-2">
                    <div class="text-gray-500 text-center py-4">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Filters Panel -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4 text-left flex items-center gap-2">
                <i data-lucide="filter" class="w-5 h-5 text-red-600"></i>
                Filter Options
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">School</label>
                    <select id="schoolFilter" class="h-11 w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-red-500">
                        <option value="">All Schools</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Team</label>
                    <select id="teamFilter" class="h-11 w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-red-500">
                        <option value="">All Teams</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Game Mode</label>
                    <select id="gameModeFilter" class="h-11 w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-red-500">
                        <option value="">All Modes</option>
                    </select>
                </div>
                
                <div class="flex items-end">
                    <button onclick="applyFilters()" class="text-white px-6 rounded-lg inline-flex items-center justify-center text-center gap-2 font-medium transition-colors hover:opacity-90 h-11 w-full" style="background-color: #EE2A3E">
                        <i data-lucide="search" class="w-4 h-4"></i>
                        Apply Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- Team Performance Summary -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4 text-left flex items-center gap-2">
                <i data-lucide="trophy" class="w-5 h-5 text-red-600"></i>
                Team Performance Summary
            </h2>
            
            <div id="teamStats" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                <!-- Victory Royales -->
                <div class="bg-yellow-50 rounded-lg p-4 text-center border border-yellow-200">
                    <div class="text-3xl font-bold text-yellow-600" id="victoryRoyales">0</div>
                    <div class="text-sm font-medium text-yellow-800">VICTORY ROYALES</div>
                    <div class="text-xs text-yellow-600" id="winRate">0% WIN RATE</div>
                </div>
                
                <!-- Matches Played -->
                <div class="bg-blue-50 rounded-lg p-4 text-center border border-blue-200">
                    <div class="text-3xl font-bold text-blue-600" id="matchesPlayed">0</div>
                    <div class="text-sm font-medium text-blue-800">MATCHES PLAYED</div>
                </div>
                
                <!-- TOP 5 MOVED TO 3RD POSITION -->
                <div class="bg-green-50 rounded-lg p-4 text-center border border-green-200">
                    <div class="text-3xl font-bold text-green-600" id="top5Count">0</div>
                    <div class="text-sm font-medium text-green-800">TOP 5</div>
                    <div class="text-xs text-green-600" id="top5Rate">0% OF GAMES</div>
                </div>
                
                <!-- TOP 10 MOVED TO 4TH POSITION -->
                <div class="bg-purple-50 rounded-lg p-4 text-center border border-purple-200">
                    <div class="text-3xl font-bold text-purple-600" id="top10Count">0</div>
                    <div class="text-sm font-medium text-purple-800">TOP 10</div>
                    <div class="text-xs text-purple-600" id="top10Rate">0% OF GAMES</div>
                </div>
                
                <!-- Avg Eliminations -->
                <div class="bg-orange-50 rounded-lg p-4 text-center border border-orange-200">
                    <div class="text-3xl font-bold text-orange-600" id="avgElims">0</div>
                    <div class="text-sm font-medium text-orange-800">AVG ELIMINATIONS</div>
                </div>
                
                <!-- Total Eliminations -->
                <div class="bg-red-50 rounded-lg p-4 text-center border border-red-200">
                    <div class="text-3xl font-bold text-red-600" id="totalElims">0</div>
                    <div class="text-sm font-medium text-red-800">TOTAL</div>
                    <div class="text-xs text-red-600">ELIMINATIONS</div>
                </div>
            </div>
        </div>

        <!-- Performance Trends Panel -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4 text-left flex items-center gap-2">
                <i data-lucide="trending-up" class="w-5 h-5 text-purple-500"></i>
                Performance Trends
            </h2>
            <div class="h-96">
                <canvas id="performanceChart"></canvas>
            </div>
        </div>

        <!-- Recent Games -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4 text-left flex items-center gap-2">
                <i data-lucide="clock" class="w-5 h-5 text-green-500"></i>
                Recent Games
            </h2>
            <div id="recentGames">
                <div class="text-gray-500 text-center py-8">Loading recent games...</div>
            </div>
        </div>
    </div>

    <script>
        // Google Sheets CSV URL
        const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS2WOF19jlQP7CuF1eG7rzVxEZybL6637Lo6lhZluKscRDl2VcIoMi_FPIkTM6PWeyXzLWDUc7amqO2/pub?output=csv';
        
        let allData = [];
        let filteredData = [];
        let isStandingsExpanded = false;
        let currentStandingsGameMode = 'Battle Royale';

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            lucide.createIcons();
            setTimeout(() => {
                loadData();
            }, 100);
        });

        function loadData() {
            console.log('=== STARTING REAL DATA LOAD FROM GOOGLE SHEETS ===');
            
            // Clear all existing data
            allData = [];
            filteredData = [];
            
            // Reset filters to default
            if (document.getElementById('schoolFilter')) {
                document.getElementById('schoolFilter').value = '';
            }
            if (document.getElementById('teamFilter')) {
                document.getElementById('teamFilter').value = '';
            }
            if (document.getElementById('gameModeFilter')) {
                document.getElementById('gameModeFilter').value = '';
            }
            if (document.getElementById('standingsGameModeFilter')) {
                document.getElementById('standingsGameModeFilter').value = 'Battle Royale';
            }
            
            // Reset standings view
            isStandingsExpanded = false;
            currentStandingsGameMode = 'Battle Royale';
            
            // Destroy existing chart if it exists
            if (window.performanceChart instanceof Chart) {
                window.performanceChart.destroy();
            }
            
            loadRealData();
        }

        async function loadRealData() {
            try {
                console.log('Fetching data from Google Sheets...');
                
                // Use CORS proxy directly since it works
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                const targetUrl = encodeURIComponent(SHEET_CSV_URL);
                
                const response = await fetch(proxyUrl + targetUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const csvText = await response.text();
                console.log('CSV data received, parsing...');
                
                parseCSVData(csvText);
                
                console.log('Generated', allData.length, 'games for', [...new Set(allData.map(d => d.teamName))].length, 'teams');
                
                filteredData = [...allData];
                
                console.log('=== CALLING UPDATE FUNCTIONS ===');
                populateFilters();
                updateStandings();
                updateLeaderboards();
                updateTeamStats();
                updateRecentGames();
                updateChart();
                console.log('=== REAL DATA LOAD COMPLETE ===');
                
            } catch (error) {
                console.error('CORS proxy failed:', error);
                console.log('Trying direct method...');
                
                // Fallback to direct method
                try {
                    const response = await fetch(SHEET_CSV_URL, {
                        method: 'GET',
                        mode: 'cors',
                        headers: {
                            'Accept': 'text/csv,text/plain,*/*'
                        }
                    });
                    
                    if (response.ok) {
                        const csvText = await response.text();
                        console.log('Direct method successful, parsing CSV data...');
                        parseCSVData(csvText);
                        
                        filteredData = [...allData];
                        
                        populateFilters();
                        updateStandings();
                        updateLeaderboards();
                        updateTeamStats();
                        updateRecentGames();
                        updateChart();
                        console.log('=== DIRECT DATA LOAD COMPLETE ===');
                        
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                } catch (directError) {
                    console.error('Both methods failed:', directError);
                    console.log('Data load failed, check your Google Sheets CSV URL and permissions');
                }
            }
        }

        function parseCSVData(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            
            console.log('CSV Headers:', headers);
            
            allData = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = parseCSVLine(line);
                if (values.length < headers.length) continue;
                
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] ? values[index].replace(/"/g, '').trim() : '';
                });
                
                // Get school and team name directly from columns
                const teamName = row['Team Name'] || '';
                const schoolName = row['School'] || '';
                
                const gameData = {
                    timestamp: row['Timestamp'] || '',
                    school: schoolName,
                    teamName: teamName,
                    date: row['Date'] || '',
                    gameMode: row['Game Mode'] || '',
                    teamPlacement: parseInt(row['Team Placement']) || 0,
                    totalPoints: parseInt(row['Total Points']) || 0,
                    p1Tag: row['P1 Tag'] || '',
                    p1Elims: parseInt(row['P1 Elims']) || 0,
                    p1Damage: parseInt(row['P1 Damage']) || 0,
                    p1Accuracy: parseFloat(row['P1 Accuracy']) || 0,
                    p2Tag: row['P2 Tag'] || '',
                    p2Elims: parseInt(row['P2 Elims']) || 0,
                    p2Damage: parseInt(row['P2 Damage']) || 0,
                    p2Accuracy: parseFloat(row['P2 Accuracy']) || 0,
                    p3Tag: row['P3 Tag'] || '',
                    p3Elims: parseInt(row['P3 Elims']) || 0,
                    p3Damage: parseInt(row['P3 Damage']) || 0,
                    p3Accuracy: parseFloat(row['P3 Accuracy']) || 0,
                    p4Tag: row['P4 Tag'] || '',
                    p4Elims: parseInt(row['P4 Elims']) || 0,
                    p4Damage: parseInt(row['P4 Damage']) || 0,
                    p4Accuracy: parseFloat(row['P4 Accuracy']) || 0,
                    totalEliminations: parseInt(row['Total Eliminations']) || 0
                };
                
                if (gameData.teamName && gameData.teamPlacement > 0) {
                    allData.push(gameData);
                }
            }
            
            console.log('Parsed', allData.length, 'valid game records');
        }

        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    values.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            values.push(current);
            
            return values;
        }

        function extractSchoolFromTeamName(teamName) {
            if (!teamName) return '';
            
            // Handle common team name patterns
            // "School Name TeamSuffix" -> "School Name"
            const words = teamName.split(' ');
            if (words.length <= 1) return teamName;
            
            // Remove common team suffixes
            const suffixes = ['Eagles', 'Warriors', 'Lions', 'Panthers', 'Storm', 'Tigers', 'Wildcats', 'Hawks', 'Bears'];
            const lastWord = words[words.length - 1];
            
            if (suffixes.includes(lastWord)) {
                return words.slice(0, -1).join(' ');
            }
            
            // If no recognized suffix, assume the last word is the team name
            return words.slice(0, -1).join(' ') || teamName;
        }

        function getPlacementPoints(placement) {
            if (placement === 1) return 25;
            if (placement >= 2 && placement <= 5) return 20;
            if (placement >= 6 && placement <= 9) return 15;
            if (placement >= 10 && placement <= 18) return 10;
            if (placement >= 19 && placement <= 25) return 5;
            return 0;
        }

        function getEliminationPoints(eliminations) {
            return Math.min(eliminations * 4, 50);
        }

        function populateFilters() {
            console.log('Populating filters...');
            const schools = [...new Set(allData.map(row => row.school))];
            const teams = [...new Set(allData.map(row => row.teamName))];
            const modes = [...new Set(allData.map(row => row.gameMode))];
            
            const schoolFilter = document.getElementById('schoolFilter');
            const teamFilter = document.getElementById('teamFilter');
            const modeFilter = document.getElementById('gameModeFilter');
            
            // Clear existing options except first
            schoolFilter.innerHTML = '<option value="">All Schools</option>';
            teamFilter.innerHTML = '<option value="">All Teams</option>';
            modeFilter.innerHTML = '<option value="">All Modes</option>';
            
            schools.forEach(school => {
                const option = document.createElement('option');
                option.value = school;
                option.textContent = school;
                schoolFilter.appendChild(option);
            });
            
            teams.forEach(team => {
                const option = document.createElement('option');
                option.value = team;
                option.textContent = team;
                teamFilter.appendChild(option);
            });
            
            modes.forEach(mode => {
                const option = document.createElement('option');
                option.value = mode;
                option.textContent = mode;
                modeFilter.appendChild(option);
            });
            
            // Add event listeners for cascading dropdowns
            schoolFilter.addEventListener('change', onSchoolFilterChange);
            teamFilter.addEventListener('change', onTeamFilterChange);
            
            console.log('Filters populated:', schools.length, 'schools,', teams.length, 'teams,', modes.length, 'modes');
        }

        function onSchoolFilterChange() {
            const selectedSchool = document.getElementById('schoolFilter').value;
            const teamFilter = document.getElementById('teamFilter');
            
            // Clear current team selection
            teamFilter.value = '';
            
            // Get teams for selected school
            let availableTeams;
            if (selectedSchool) {
                availableTeams = [...new Set(allData
                    .filter(row => row.school === selectedSchool)
                    .map(row => row.teamName))];
            } else {
                availableTeams = [...new Set(allData.map(row => row.teamName))];
            }
            
            // Rebuild team dropdown
            teamFilter.innerHTML = '<option value="">All Teams</option>';
            availableTeams.forEach(team => {
                const option = document.createElement('option');
                option.value = team;
                option.textContent = team;
                teamFilter.appendChild(option);
            });
        }

        function onTeamFilterChange() {
            const selectedTeam = document.getElementById('teamFilter').value;
            const schoolFilter = document.getElementById('schoolFilter');
            
            if (selectedTeam) {
                // Find the school for this team
                const teamSchool = allData.find(row => row.teamName === selectedTeam)?.school;
                if (teamSchool) {
                    schoolFilter.value = teamSchool;
                }
            }
        }

        function updateTeamStats() {
            console.log('=== UPDATING TEAM STATS ===');
            console.log('filteredData length:', filteredData.length);
            
            const gamesPlayed = filteredData.length;
            if (gamesPlayed === 0) {
                console.log('No filtered data available');
                return;
            }
            
            const wins = filteredData.filter(row => row.teamPlacement === 1).length;
            const top5s = filteredData.filter(row => row.teamPlacement <= 5).length;
            const top10s = filteredData.filter(row => row.teamPlacement <= 10).length;
            const totalEliminations = filteredData.reduce((sum, row) => sum + row.totalEliminations, 0);
            
            const winRate = ((wins / gamesPlayed) * 100).toFixed(0);
            const top5Rate = ((top5s / gamesPlayed) * 100).toFixed(0);
            const top10Rate = ((top10s / gamesPlayed) * 100).toFixed(0);
            const avgElims = (totalEliminations / gamesPlayed).toFixed(0);
            
            console.log('Calculated stats:', {
                gamesPlayed, wins, top5s, top10s, totalEliminations,
                winRate, top5Rate, top10Rate, avgElims
            });
            
            // Update DOM elements
            document.getElementById('matchesPlayed').textContent = gamesPlayed;
            document.getElementById('victoryRoyales').textContent = wins;
            document.getElementById('winRate').textContent = `${winRate}% WIN RATE`;
            document.getElementById('top5Count').textContent = top5s;
            document.getElementById('top5Rate').textContent = `${top5Rate}% OF GAMES`;
            document.getElementById('top10Count').textContent = top10s;
            document.getElementById('top10Rate').textContent = `${top10Rate}% OF GAMES`;
            document.getElementById('avgElims').textContent = avgElims;
            document.getElementById('totalElims').textContent = totalEliminations;
            
            console.log('Team stats DOM updated');
        }

        // NEW FUNCTION: Update standings when game mode filter changes
        function updateStandingsForGameMode() {
            currentStandingsGameMode = document.getElementById('standingsGameModeFilter').value;
            console.log('Updating standings for game mode:', currentStandingsGameMode || 'All Modes');
            updateStandings();
        }

        function updateStandings() {
            console.log('=== UPDATING STANDINGS ===');
            const standings = calculateTeamStandings();
            console.log('Calculated', standings.length, 'team standings for mode:', currentStandingsGameMode || 'All Modes');
            updateTop30Standings(standings.slice(0, 30));
            updateAllStandings(standings);
        }

        // MODIFIED FUNCTION: Calculate standings with game mode filter
        function calculateTeamStandings() {
            const teamStats = {};
            
            // Filter data by current standings game mode if selected
            let dataToUse = allData;
            if (currentStandingsGameMode) {
                // Debug: Log what we're filtering for and what's available
                console.log('Filtering for game mode:', `"${currentStandingsGameMode}"`);
                console.log('Available game modes in data:', [...new Set(allData.map(row => `"${row.gameMode}"`))]);
                
                // Map user selection to actual data values
                let actualGameMode = currentStandingsGameMode;
                if (currentStandingsGameMode === 'Battle Royale') {
                    actualGameMode = 'Battle Royale'; // Map to what's actually in the data
                }
                
                // Use case-insensitive and trimmed comparison to handle variations
                dataToUse = allData.filter(row => {
                    const normalizedRowMode = row.gameMode?.toString().trim().toLowerCase() || '';
                    const normalizedFilterMode = actualGameMode.toString().trim().toLowerCase();
                    return normalizedRowMode === normalizedFilterMode;
                });
                
                console.log('Mapped filter mode:', `"${actualGameMode}"`);
                console.log('Filtered data length:', dataToUse.length);
                console.log('Sample filtered records:', dataToUse.slice(0, 3).map(row => ({ 
                    team: row.teamName, 
                    mode: `"${row.gameMode}"`,
                    points: row.totalPoints 
                })));
            }
            
            dataToUse.forEach(row => {
                if (!teamStats[row.teamName]) {
                    teamStats[row.teamName] = { totalPoints: 0, games: 0, wins: 0, top5s: 0, totalElims: 0 };
                }
                teamStats[row.teamName].totalPoints += row.totalPoints;
                teamStats[row.teamName].games++;
                if (row.teamPlacement === 1) teamStats[row.teamName].wins++;
                if (row.teamPlacement <= 5) teamStats[row.teamName].top5s++;
                teamStats[row.teamName].totalElims += row.totalEliminations;
            });
            
            const results = Object.entries(teamStats)
                .map(([team, stats]) => ({ team, ...stats }))
                .sort((a, b) => b.totalPoints - a.totalPoints)
                .map((team, index) => ({ ...team, rank: index + 1, clinched: index < 25 }));
                
            console.log('Final standings results:', results.length, 'teams');
            
            return results;
        }

        function updateTop30Standings(top30) {
            console.log('Updating top 30 standings with', top30.length, 'teams');
            const columns = [top30.slice(0, 10), top30.slice(10, 20), top30.slice(20, 30)];
            
            const container = document.getElementById('top30Standings');
            container.innerHTML = columns.map((column, colIndex) => `
                <div class="space-y-2">
                    <h4 class="text-sm font-semibold text-gray-600 mb-3 text-center">
                        ${colIndex === 0 ? 'Top 10' : colIndex === 1 ? 'Ranks 11-20' : 'Ranks 21-30'}
                    </h4>
                    ${column.map(team => `
                        <div class="flex items-center justify-between p-3 rounded-lg transition-colors ${getRankingStyling(team.rank)}">
                            <div class="flex items-center gap-3">
                                <span class="w-6 h-6 rounded-full ${getRankBadgeColor(team.rank)} text-white text-xs font-bold flex items-center justify-center">
                                    ${team.rank}
                                </span>
                                <span class="font-medium text-gray-800 text-sm">${team.team}</span>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-gray-900 text-sm">${team.totalPoints}</div>
                                <div class="text-xs text-gray-500">${team.games} games</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `).join('');
            
            lucide.createIcons();
        }

        function updateAllStandings(standings) {
            const container = document.getElementById('allStandings');
            
            container.innerHTML = `
                <div class="flex items-center justify-between p-2 bg-gray-100 border-b-2 border-gray-200 font-semibold text-sm text-gray-700">
                    <div class="flex items-center gap-3">
                        <span class="w-8 h-6 flex items-center justify-center">Rank</span>
                        <span>Team Name</span>
                    </div>
                    <div class="flex items-center text-xs">
                        <span class="font-semibold w-20 text-center">Total Points</span>
                        <span class="text-gray-600 w-12 text-center">Games</span>
                        <span class="text-gray-600 w-12 text-center">Wins</span>
                        <span class="text-gray-600 w-12 text-center">Top 5</span>
                        <span class="text-gray-600 w-16 text-center">Eliminations</span>
                    </div>
                </div>
                
                <div class="space-y-1">
                    ${standings.map(team => `
                        <div class="flex items-center justify-between p-2 rounded-lg hover:bg-gray-50 transition-colors">
                            <div class="flex items-center gap-3">
                                <span class="w-8 h-6 rounded ${getRankBadgeColor(team.rank)} text-white text-xs font-bold flex items-center justify-center">
                                    ${team.rank}
                                </span>
                                <span class="font-medium text-gray-800">${team.team}</span>
                            </div>
                            <div class="flex items-center text-sm">
                                <span class="font-bold text-gray-900 w-20 text-center">${team.totalPoints.toLocaleString()}</span>
                                <span class="text-gray-500 w-12 text-center">${team.games}G</span>
                                <span class="text-gray-500 w-12 text-center">${team.wins}W</span>
                                <span class="text-gray-500 w-12 text-center">${team.top5s} T5</span>
                                <span class="text-gray-500 w-16 text-center">${team.totalElims} Elims</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function getRankingStyling(rank) {
            if (rank === 1) return 'bg-gradient-to-r from-yellow-100 to-yellow-200 border border-yellow-300';
            if (rank <= 25) return 'bg-blue-50 border border-blue-200';
            return 'bg-gray-50 border border-gray-200';
        }

        function getRankBadgeColor(rank) {
            if (rank === 1) return 'bg-yellow-600';
            if (rank <= 25) return 'bg-blue-600';
            return 'bg-gray-500';
        }

        function toggleStandings() {
            const top30Container = document.getElementById('top30Standings');
            const allContainer = document.getElementById('allStandings');
            const expandText = document.getElementById('expandText');
            const expandIcon = document.getElementById('expandIcon');
            
            isStandingsExpanded = !isStandingsExpanded;
            
            if (isStandingsExpanded) {
                top30Container.style.display = 'none';
                allContainer.style.display = 'block';
                expandText.textContent = 'Show Top 30';
                expandIcon.setAttribute('data-lucide', 'compress');
            } else {
                top30Container.style.display = 'grid';
                allContainer.style.display = 'none';
                expandText.textContent = 'Show All Teams';
                expandIcon.setAttribute('data-lucide', 'expand');
            }
            
            lucide.createIcons();
        }

        function updateLeaderboards() {
            console.log('=== UPDATING LEADERBOARDS ===');
            updateTeamLeaderboard();
            updatePointsLeaderboard();
            updateElimsLeaderboard();
        }

        function updateTeamLeaderboard() {
            const teamStats = {};
            allData.forEach(row => {
                if (!teamStats[row.teamName]) teamStats[row.teamName] = { placements: [] };
                teamStats[row.teamName].placements.push(row.teamPlacement);
            });
            
            const leaderboard = Object.entries(teamStats)
                .map(([team, stats]) => ({
                    team,
                    avgPlacement: stats.placements.reduce((a, b) => a + b, 0) / stats.placements.length
                }))
                .sort((a, b) => a.avgPlacement - b.avgPlacement)
                .slice(0, 5);
            
            document.getElementById('teamLeaderboard').innerHTML = leaderboard.map((item, index) => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center gap-3">
                        <span class="w-6 h-6 rounded-full bg-yellow-100 text-yellow-800 text-sm font-bold flex items-center justify-center">${index + 1}</span>
                        <span class="font-medium text-gray-800">${item.team}</span>
                    </div>
                    <span class="font-bold text-yellow-600">${item.avgPlacement.toFixed(1)}</span>
                </div>
            `).join('');
        }

        function updatePointsLeaderboard() {
            const teamStats = {};
            allData.forEach(row => {
                if (!teamStats[row.teamName]) teamStats[row.teamName] = { points: [] };
                teamStats[row.teamName].points.push(row.totalPoints);
            });
            
            const leaderboard = Object.entries(teamStats)
                .map(([team, stats]) => ({
                    team,
                    avgPoints: Math.round(stats.points.reduce((a, b) => a + b, 0) / stats.points.length)
                }))
                .sort((a, b) => b.avgPoints - a.avgPoints)
                .slice(0, 5);
            
            document.getElementById('pointsLeaderboard').innerHTML = leaderboard.map((item, index) => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center gap-3">
                        <span class="w-6 h-6 rounded-full bg-blue-100 text-blue-800 text-sm font-bold flex items-center justify-center">${index + 1}</span>
                        <span class="font-medium text-gray-800">${item.team}</span>
                    </div>
                    <span class="font-bold text-blue-600">${item.avgPoints}</span>
                </div>
            `).join('');
        }

        function updateElimsLeaderboard() {
            const teamStats = {};
            allData.forEach(row => {
                if (!teamStats[row.teamName]) teamStats[row.teamName] = { elims: [] };
                teamStats[row.teamName].elims.push(row.totalEliminations);
            });
            
            const leaderboard = Object.entries(teamStats)
                .map(([team, stats]) => ({
                    team,
                    avgElims: (stats.elims.reduce((a, b) => a + b, 0) / stats.elims.length).toFixed(1)
                }))
                .sort((a, b) => parseFloat(b.avgElims) - parseFloat(a.avgElims))
                .slice(0, 5);
            
            document.getElementById('elimsLeaderboard').innerHTML = leaderboard.map((item, index) => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center gap-3">
                        <span class="w-6 h-6 rounded-full bg-red-100 text-red-800 text-sm font-bold flex items-center justify-center">${index + 1}</span>
                        <span class="font-medium text-gray-800">${item.team}</span>
                    </div>
                    <span class="font-bold text-red-600">${item.avgElims}</span>
                </div>
            `).join('');
        }

        function updateRecentGames() {
            console.log('=== UPDATING RECENT GAMES ===');
            const recent = allData.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);
            console.log('Recent games:', recent.length);
            
            document.getElementById('recentGames').innerHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-700">Date</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-700">School</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-700">Team</th>
                                <th class="px-2 py-3 text-center text-xs font-medium text-gray-700">Placement</th>
                                <th class="px-2 py-3 text-center text-xs font-medium text-gray-700">Points</th>
                                <th class="px-2 py-3 text-center text-xs font-medium text-gray-700">Eliminations</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${recent.map(game => `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-3 text-sm">${game.date}</td>
                                    <td class="px-3 py-3 text-sm">${game.school}</td>
                                    <td class="px-3 py-3 text-sm font-medium">${game.teamName}</td>
                                    <td class="px-2 py-3 text-sm text-center font-bold ${game.teamPlacement <= 5 ? 'text-green-600' : 'text-gray-600'}">${game.teamPlacement}</td>
                                    <td class="px-2 py-3 text-sm text-center">${game.totalPoints}</td>
                                    <td class="px-2 py-3 text-sm text-center">${game.totalEliminations}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            console.log('Recent games table updated');
        }

        function updateChart() {
            console.log('=== UPDATING CHART ===');
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            if (window.performanceChart instanceof Chart) {
                window.performanceChart.destroy();
            }
            
            const chartData = allData
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .slice(-20);
            
            console.log('Chart data points:', chartData.length);
            
            window.performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.map(game => game.date),
                    datasets: [{
                        label: 'Team Placement',
                        data: chartData.map(game => game.teamPlacement),
                        borderColor: '#EE2A3E',
                        backgroundColor: 'rgba(238, 42, 62, 0.1)',
                        tension: 0.4,
                        yAxisID: 'placement',
                        fill: true
                    }, {
                        label: 'Total Points',
                        data: chartData.map(game => game.totalPoints),
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        yAxisID: 'points',
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        placement: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            reverse: true,
                            min: 1,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Placement',
                                color: '#EE2A3E'
                            },
                            ticks: {
                                color: '#EE2A3E'
                            }
                        },
                        points: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Points',
                                color: '#3B82F6'
                            },
                            ticks: {
                                color: '#3B82F6'
                            },
                            grid: {
                                drawOnChartArea: false,
                            }
                        }
                    }
                }
            });
            console.log('Chart created successfully');
        }

        function applyFilters() {
            console.log('=== APPLYING FILTERS ===');
            const schoolFilter = document.getElementById('schoolFilter').value;
            const teamFilter = document.getElementById('teamFilter').value;
            const gameModeFilter = document.getElementById('gameModeFilter').value;
            
            console.log('Filter values:', { schoolFilter, teamFilter, gameModeFilter });
            
            filteredData = allData.filter(row => {
                const matchesSchool = !schoolFilter || row.school === schoolFilter;
                const matchesTeam = !teamFilter || row.teamName === teamFilter;
                const matchesMode = !gameModeFilter || row.gameMode === gameModeFilter;
                
                return matchesSchool && matchesTeam && matchesMode;
            });
            
            console.log('Filtered to', filteredData.length, 'games');
            
            updateTeamStats();
            updateRecentGames();
            updateChart();
        }
    </script>
</body>
</html>
